---
title: "Análisis de sentimiento de música folklorica boliviana"
author: Laboratorio de Tecnologías Sociale
output: html_notebook
---

# Instalar paquetes y configuraciones básicas

```{r}
library(tidyverse)
library(tidytext)
library(stopwords)
library(syuzhet)
library(wordcloud2)
library(ggwordcloud)
library(patchwork)

theme_set(theme_minimal())
```


# Cargar datos

```{r}
metadata <- read_csv("data/metadata.csv")
spotify_features <- read_csv("data/spotify_features.csv")
archivos_letras <- list.files("data/letras/", full.names = T)
letras <- map_dfr(archivos_letras, ~tibble(archivo = basename(.x), contenido = read_file(.x)))

letras <- letras %>%
  mutate(id = parse_number(str_remove(archivo, ".txt"))) %>%
  relocate(id, .before = everything()) %>%
  arrange(id)
data <- metadata %>%
  left_join(letras, by = join_by(N == id))

```


# Análisis de letras

Posibles comparaciones por:
- Lugar
- Ritmo
- Tal vez región: occidente, valle, oriente

### Análisis de contenido

#### Frecuencias
```{r}
palabras_vacias <- bind_rows(
  tibble(palabra = stopwords("es")),
  tibble(palabra = c())
  )
data_palabras <- data %>%
  unnest_tokens(palabra, contenido) %>%
  anti_join(palabras_vacias)
```
```{r, fig.height=5}
palabras_conteo <- data_palabras %>%
  count(palabra, sort = T)

palabras_conteo %>%
  slice_head(n = 50) %>%
  mutate(palabra = reorder(palabra, n)) %>%
  ggplot(aes(n, palabra)) +
  geom_col() +
  labs(y = NULL)
```

```{r}
palabras_conteo  %>%
  slice_head(n = 50) %>%
  rename(word = palabra, freq = n) %>%
  wordcloud2()
```

```{r, fig.height=12}
data_palabras_ritmo <- data_palabras %>%
  group_by(Ritmo) %>%
  count(palabra) %>%
  slice_head(n = 10)


crear_wordcloud <- function(data, ritmo) {
  data %>%
    filter(Ritmo == ritmo) %>%
    group_by(Ritmo) %>%
    slice_head(n = 3) %>%
    ungroup %>%
    ggplot() +
    geom_text_wordcloud(aes(label = palabra)) +
    labs(caption = ritmo)
}

lista_ritmos <- unique(data$Ritmo)
lista_plots <- map(lista_ritmos, ~crear_wordcloud(data_palabras_ritmo, .x))

wrap_plots(lista_plots)

```


#### Inversas

### Redes semánticas

### Análisis de sentimiento

```{r}
sentimientos_contenido <- get_nrc_sentiment(data$contenido, language = "spanish")
write_csv(sentimientos_contenido, "output/sentimientos_contenido.csv")

sentimientos_traduccion <- c("Ira" = "anger", "Anticipacion" = "anticipation", "Asco" = "disgust", "Miedo" = "fear", "Alegria" = "joy", "Tristeza" = "sadness", "Sorpresa" = "surprise", "Confianza" = "trust", "Negativo" = "negative", "Positivo" = "positive")

sentimientos_contenido <- sentimientos_contenido %>%
  rename(sentimientos_traduccion)

sentimientos_contenido <- sentimientos_contenido %>% 
  rowid_to_column()

data <- data %>%
  left_join(sentimientos_contenido, by = join_by(N == rowid))

```

TODO: general de sentimientos
```{r}
suma_general_sentimientos <- data %>%
  summarize(across(Ira:Positivo, sum)) %>%
  pivot_longer(everything(), names_to = "sentimiento", values_to = "valor") %>%
  mutate(porcentaje)

suma_general_sentimientos_6 <- suma_general_sentimientos %>%
  slice_head(n = 8) %>%
  mutate(porcentaje = valor / sum(valor) * 100)

suma_general_sentimientos_2 <- suma_general_sentimientos %>%
  slice_tail(n = 2) %>%
  mutate(porcentaje = valor / sum(valor) * 100)

```

```{r}
suma_general_sentimientos_6 %>%
  arrange(desc(porcentaje))
```

```{r}
suma_general_sentimientos_2
```


```{r}
suma_sentimientos_grupos <- data %>%
  group_by(Ritmo) %>%
  summarize(across(Ira:Positivo, sum)) %>%
  pivot_longer(-Ritmo, names_to = "sentimiento", values_to = "valor") 
  
```


```{r}
suma_sentimientos_grupos %>%
  filter(!sentimiento %in% c("Positivo", "Negativo")) %>%
  ggplot() +
  geom_col(aes(x = Ritmo, valor, fill = sentimiento), position = position_fill()) +
  coord_flip()
```
```{r}
suma_sentimientos %>%
  filter(sentimiento %in% c("Positivo", "Negativo")) %>%
  ggplot() +
  geom_col(aes(x = Ritmo, valor, fill = sentimiento), position = position_fill()) +
  coord_flip()
```



# Análisis de música

Según las métricas de Spotify

- Energía, danzabilidad x Ritmo

```{r}
# uniendo los datos
data <- data %>%
  left_join(spotify_features, by = join_by(N == index))
```

```{r}
danzabilidad_vs_ritmo <- data %>%
  group_by(Ritmo) %>%
  summarize(danzabilidad = mean(danceability))

danzabilidad_vs_ritmo %>%
  ggplot() +
  geom_col(aes(reorder(Ritmo, danzabilidad), danzabilidad)) +
  coord_flip()
```

- Valence, positividad y negatividad -> con la letra

```{r}
valencia_vs_ritmo <- data %>%
  group_by(Ritmo) %>%
  summarize(valencia = mean(valence))

valencia_vs_ritmo %>%
  ggplot() +
  geom_col(aes(reorder(Ritmo, valencia), valencia)) +
  coord_flip()


```

- Valencia de musica versus valencia en letra
```{r}

```




